<?php	$server_link = '../';	$rel = $server_link;	$page = './create_req.php';	include_once $server_link.'dao/connectDb.php';	include_once $server_link.'dao/mysqlUtils.php';	include_once $server_link.'dao/retrieveUtils.php';	include_once $server_link.'filtres/filtre.php';	include_once $server_link.'private_datas/filtre_fonc.php';	include_once $server_link.'globals/conventions.php';	include_once $server_link.'globals/env.php';	include_once $server_link.'utils/convertVars.php';		$usr = null;	$usr['adminkey'] = isset($_GET['adminkey']) ? $_GET['adminkey'] : null;	filtreAdmin($usr); // exit if incorrect		$dbVars = setDbVars(getStatus());	dbConnect();		$get_formid = isset($_GET['formid']) ? $_GET['formid'] : null;	$get_service_id = isset($_GET['service_id']) ? $_GET['service_id'] : null;	$get_type = isset($_GET['type']) ? $_GET['type'] : null;	$get_id = isset($_GET['id']) ? $_GET['id'] : null;	$form1_res = null;	$form2_res = null;		$service = getService($get_service_id);		if($get_formid == 1){		if($get_type == 2){ // supprimer citation			$form1_res = "supprimer la citation ".$get_id." du service ".$get_service_id." (".$service['name'].") :<br/>";						$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` WHERE service_id=".$get_service_id." AND id=".$get_id.";";			$result = mysql_query($req);			if($result == null || mysql_num_rows($result) == 0){$quote = null;}			else{$quote = mysql_fetch_array($result, MYSQL_ASSOC);}						if($quote == null){				$form1_res .= "<b>Cette citation n'existe pas !</b><br/><br/>";			}			else{				$form1_res .= "Citation de ".$quote['publisher']." : <br/>";				$form1_res .= "<div style=\"font-style: italic; margin-left: 20px;\">".nl2br(utf8_encode($quote['quote']))."<hr/>".nl2br(utf8_encode($quote['explanation']))."</div><br/>";								$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."comment` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('quote')." AND elt_id=".$get_id.";";				$result = mysql_query($req);				$form1_res .= "<b>Supprimer d'abord les ".$quote['comments']." commentaires de la citation.</b> Ids : ";				$first = true;				while ($result != null && $comment = mysql_fetch_array($result, MYSQL_ASSOC)) {					if($first == true){$first = false;}					else{$form1_res .= ", ";}					$form1_res .= $comment['id'];				}				$form1_res .= "<br/>";			}						$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection_quote` WHERE service_id=".$get_service_id." AND quote_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection` WHERE service_id=".$get_service_id." AND id NOT IN (SELECT DISTINCT selection_id FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection_quote`);<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."vote` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('quote')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."suivi` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('quote')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."reported` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('quote')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."petition` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('quote')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."history` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('quote')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."category_quote` WHERE service_id=".$get_service_id." AND quote_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` WHERE service_id=".$get_service_id." AND id=".$get_id.";<br/>";		}		else if($get_type == 3){ // supprimer commentaire			$form1_res = "<br/><br/>supprimer le commentaire ".$get_id." du service ".$get_service_id." (".$service['name'].") :<br/>";						$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."comment` WHERE service_id=".$get_service_id." AND id=".$get_id.";";			$result = mysql_query($req);			if($result == null || mysql_num_rows($result) == 0){$comment = null;}			else{$comment = mysql_fetch_array($result, MYSQL_ASSOC);}						if($comment == null){				$form1_res .= "<b>Ce commentaire n'existe pas !</b><br/><br/>";				$form1_res .= "UPDATE `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` SET comments=comments-1 WHERE service_id=".$get_service_id." AND id=".$comment['elt_id']."; // si c'est un commentaire sur une citation !<br/>";			}			else{				$form1_res .= "Commentaire de la <b>".codeToRessourceType($comment['elt_type'])." #".$comment['elt_id']."</b> par ".$comment['publisher']." : <br/>";				$form1_res .= "<div style=\"font-style: italic; margin-left: 20px;\">".nl2br(utf8_encode($comment['comment']))."</div><br/>";				if(codeToRessourceType($comment['elt_type']) == 'quote'){$form1_res .= "UPDATE `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` SET comments=comments-1 WHERE service_id=".$get_service_id." AND id=".$comment['elt_id'].";<br/>";}			}						$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."vote` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('comment')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."suivi` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('comment')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."reported` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('comment')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."history` WHERE service_id=".$get_service_id." AND elt_type=".ressourceTypeToCode('comment')." AND elt_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."comment` WHERE service_id=".$get_service_id." AND id=".$get_id.";<br/>";		}		else if($get_type == 6){ // supprimer sélection			$form1_res = "supprimer la sélection ".$get_id." du service ".$get_service_id." (".$service['name'].") :<br/>";						$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection` WHERE service_id=".$get_service_id." AND id=".$get_id.";";			$result = mysql_query($req);			if($result == null || mysql_num_rows($result) == 0){$selection = null;}			else{$selection = mysql_fetch_array($result, MYSQL_ASSOC);}						if($selection == null){				$form1_res .= "<b>Cette sélection n'existe pas !</b><br/><br/>";			}			else{				$form1_res .= "<b>Sélection '".$selection['name']."'.</b> Propositions : ";				$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection_quote` WHERE service_id=".$get_service_id." AND selection_id=".$get_id.";";				$result = mysql_query($req);				$first = true;				while ($result != null && $ids = mysql_fetch_array($result, MYSQL_ASSOC)) {					if($first == true){$first = false;}					else{$form1_res .= ", ";}					$form1_res .= $ids['quote_id'];				}				$form1_res .= "<br/><br/>";			}						$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection_quote` WHERE service_id=".$get_service_id." AND selection_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection` WHERE service_id=".$get_service_id." AND id=".$get_id.";<br/>";		}		else if($get_type == 7){ // supprimer catégorie			$form1_res = "supprimer la catégorie ".$get_id." du service ".$get_service_id." (".$service['name'].") :<br/>";						$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."category` WHERE service_id=".$get_service_id." AND id=".$get_id.";";			$result = mysql_query($req);			if($result == null || mysql_num_rows($result) == 0){$category = null;}			else{$category = mysql_fetch_array($result, MYSQL_ASSOC);}						if($category == null){				$form1_res .= "<b>Cette catégorie n'existe pas !</b><br/><br/>";			}			else{				$form1_res .= "<b>Catégorie '".$category['name']."'.</b> Propositions : ";				$req = "SELECT * FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` WHERE service_id=".$get_service_id." AND category=".$get_id.";";				$result = mysql_query($req);				$first = true;				while ($result != null && $ids = mysql_fetch_array($result, MYSQL_ASSOC)) {					if($first == true){$first = false;}					else{$form1_res .= ", ";}					$form1_res .= $ids['id'];				}				$form1_res .= "<br/><br/>";			}						$form1_res .= "UPDATE `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` SET category=NULL WHERE service_id=".$get_service_id." AND category=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."category_quote` WHERE service_id=".$get_service_id." AND category_id=".$get_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."category` WHERE service_id=".$get_service_id." AND id=".$get_id.";<br/>";		}		else if($get_type == 8){ // supprimer service			$form1_res = "supprimer le service ".$get_service_id." (".$service['name'].") :<br/>";						$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."sqlreq_log` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."app_log` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."api_log` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."vote` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."suivi` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."reported` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."petition` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."history` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection_quote` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."selection` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."category_quote` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."category` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."comment` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."quote` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."key_cpt` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."id_increment` WHERE service_id=".$get_service_id.";<br/>";			$form1_res .= "DELETE FROM `".$dbVars['DbName']."`.`".$dbVars['DbPrefix']."service` WHERE service_id=".$get_service_id.";<br/>";		}	}	else if($get_formid == 2){			}		unset($req);	dbDisconnect();?><!doctype html><head>	<meta charset="UTF-8">	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">		<title>Create req</title>	<meta name="description" content="">	<meta name="author" content="">		<meta name="viewport" content="width=device-width, initial-scale=1.0">	<style>	h1{		margin: 0px;	}	td{		padding-left: 10px;		padding-right: 10px;		vertical-align: top;	}	table{		border-collapse:collapse;	}	input.id {		width: 30px;	}	</style></head><body>	<div>		<table><tr><td style="width: 290px;">			<form>				<h1>Supprimer contenu :</h1>				<input type="hidden" name="adminkey" value="<?php echo $usr['adminkey']; ?>" />				<input type="hidden" name="formid" value="1" />				<table>					<tr><td>Service id : </td><td>						<select name="service_id">							<option></option>							<?php								foreach(getServices() as $key => $service){									echo '<option value="'.$service['id'].'"';									if($get_formid == 1 && $get_service_id == $service['id']){echo "selected";}									echo '>'.$service['id'].' : '.$service['name'].'</option>';								}							?>						</select>					</td></tr>					<tr><td>Contenu type : </td><td>						<select name="type">							<option></option>							<option value="2"<?php if($get_formid == 1 && $get_type == 2){echo "selected";} ?>>Citation</option>							<option value="3"<?php if($get_formid == 1 && $get_type == 3){echo "selected";} ?>>Commentaire</option>							<option value="6"<?php if($get_formid == 1 && $get_type == 6){echo "selected";} ?>>Sélection</option>							<option value="7"<?php if($get_formid == 1 && $get_type == 7){echo "selected";} ?>>Catégorie</option>							<option value="8"<?php if($get_formid == 1 && $get_type == 8){echo "selected";} ?>>Service</option>						</select>					</td></tr>					<tr><td>Contenu id : </td><td><input type="text" name="id"<?php if($get_formid == 1 && $get_type != 8){echo ' value="'.$get_id.'"';} ?> class="id" /></td></tr>				</table>				<input type="submit" value="Voir requêtes" />			</form>		</td><td>			<?php echo $form1_res; ?>		</td></tr></table>	</div>	<hr/>		<div>		<table><tr><td style="width: 290px;">			<form>				<h1>Autre action :</h1>				<input type="hidden" name="adminkey" value="<?php echo $usr['adminkey']; ?>" />				<input type="hidden" name="formid" value="2" />																<input type="submit" value="Voir requêtes" />			</form>		</td><td>			<?php echo $form2_res; ?>		</td></tr></table>	</div>	<hr/>		<a href="./?adminkey=<?php echo $_GET['adminkey']; ?>"><= retour index</a></body></html>